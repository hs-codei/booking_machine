---
import { siteConfig } from '../../site.config';
import '../styles/global.css';

interface Props {
  title: string;
  description?: string;
  canonicalUrl?: string;
  ogImage?: string;
  noindex?: boolean;
}

const {
  title,
  description = siteConfig.meta.defaultDescription,
  canonicalUrl,
  ogImage = siteConfig.meta.ogImage,
  noindex = false
} = Astro.props;

const fullTitle = title.includes(siteConfig.name) ? title : `${title}${siteConfig.meta.titleSuffix}`;
const canonical = canonicalUrl || new URL(Astro.url.pathname, siteConfig.siteUrl).href;

// Generate color CSS variables from config
const colorStyles = Object.entries(siteConfig.colors)
  .map(([key, value]) => {
    const cssVar = key.replace(/([A-Z])/g, '-$1').toLowerCase();
    return `--color-${cssVar}: ${value};`;
  })
  .join(' ');

// Schema.org LocalBusiness markup
const schemaMarkup = {
  "@context": "https://schema.org",
  "@type": siteConfig.industry === "physio" ? "Physiotherapy" : "LocalBusiness",
  "name": siteConfig.name,
  "description": description,
  "url": siteConfig.siteUrl,
  "telephone": siteConfig.phoneTel,
  "email": siteConfig.email,
  "address": {
    "@type": "PostalAddress",
    "streetAddress": siteConfig.address.street,
    "addressLocality": siteConfig.address.city,
    "addressRegion": siteConfig.address.city,
    "postalCode": siteConfig.address.postal,
    "addressCountry": siteConfig.address.country
  },
  "geo": {
    "@type": "GeoCoordinates",
    "latitude": siteConfig.geo.latitude,
    "longitude": siteConfig.geo.longitude
  },
  "openingHoursSpecification": siteConfig.hoursStructured.map(h => ({
    "@type": "OpeningHoursSpecification",
    "dayOfWeek": h.days,
    "opens": h.opens,
    "closes": h.closes
  })),
  "priceRange": "$$",
  "aggregateRating": {
    "@type": "AggregateRating",
    "ratingValue": siteConfig.rating,
    "reviewCount": siteConfig.reviewCount
  },
  "image": `${siteConfig.siteUrl}/images/og-image.jpg`
};
---

<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Title & Description -->
  <title>{fullTitle}</title>
  <meta name="description" content={description}>

  <!-- Robots -->
  {noindex ? (
    <meta name="robots" content="noindex, nofollow">
  ) : (
    <meta name="robots" content="index, follow">
  )}

  <!-- Canonical -->
  <link rel="canonical" href={canonical}>

  <!-- Open Graph -->
  <meta property="og:title" content={fullTitle}>
  <meta property="og:description" content={description}>
  <meta property="og:type" content="website">
  <meta property="og:url" content={canonical}>
  <meta property="og:image" content={`${siteConfig.siteUrl}${ogImage}`}>
  <meta property="og:locale" content="de_DE">
  <meta property="og:site_name" content={siteConfig.name}>

  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content={fullTitle}>
  <meta name="twitter:description" content={description}>

  <!-- Favicon -->
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  <link rel="icon" type="image/x-icon" href="/favicon.ico">

  <!-- Preconnect to Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display&family=DM+Sans:ital,wght@0,400;0,500;0,600;0,700;1,400&display=swap" rel="stylesheet">

  <!-- Schema.org Markup -->
  <script type="application/ld+json" set:html={JSON.stringify(schemaMarkup)} />

  <!-- Dynamic Color Variables -->
  <style define:vars={{ colorStyles }} set:html={`:root { ${colorStyles} }`}></style>
</head>
<body>
  <slot />

  <!-- Scroll Animation Script -->
  <script>
    // Intersection Observer for scroll-triggered animations
    document.addEventListener('DOMContentLoaded', () => {
      const observer = new IntersectionObserver((entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting) {
            entry.target.classList.add('visible');
            observer.unobserve(entry.target);
          }
        });
      }, {
        threshold: 0.1,
        rootMargin: '0px 0px -50px 0px'
      });

      document.querySelectorAll('.animate-on-scroll').forEach((el) => {
        observer.observe(el);
      });
    });

    // Smooth scroll for anchor links
    document.querySelectorAll('a[href^="#"]').forEach((anchor) => {
      anchor.addEventListener('click', (e) => {
        e.preventDefault();
        const target = document.querySelector(anchor.getAttribute('href'));
        if (target) {
          target.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
      });
    });
  </script>
</body>
</html>
