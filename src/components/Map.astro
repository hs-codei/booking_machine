---
import { siteConfig } from '../../site.config';
---

<section class="map-section section--alt">
  <div class="container">
    <div class="map-wrapper" id="map-container">
      <!-- Consent placeholder (shown by default) -->
      <div class="map-consent" id="map-consent">
        <div class="consent-content">
          <svg class="consent-icon" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
          </svg>
          <h3>Google Maps laden</h3>
          <p>
            Mit Klick auf "Karte anzeigen" werden Daten an Google Ã¼bertragen.
            <a href="/datenschutz">Mehr erfahren</a>
          </p>
          <button class="btn btn-primary" id="load-map-btn">
            Karte anzeigen
          </button>
          <p class="consent-address">
            <strong>{siteConfig.name}</strong><br>
            {siteConfig.address.street}, {siteConfig.address.postal} {siteConfig.address.city}
          </p>
        </div>
      </div>

      <!-- Actual map iframe (hidden until consent) -->
      <iframe
        id="map-iframe"
        data-src={siteConfig.googleMapsEmbed}
        allowfullscreen=""
        loading="lazy"
        referrerpolicy="no-referrer-when-downgrade"
        title={`Standort ${siteConfig.name}`}
        style="display: none;"
      ></iframe>
    </div>
  </div>
</section>

<script>
  const CONSENT_KEY = 'maps-consent';
  const consent = document.getElementById('map-consent');
  const iframe = document.getElementById('map-iframe') as HTMLIFrameElement;
  const button = document.getElementById('load-map-btn');

  function loadMap() {
    if (iframe && consent) {
      const src = iframe.getAttribute('data-src');
      if (src) {
        iframe.src = src;
        iframe.style.display = 'block';
        consent.style.display = 'none';
        localStorage.setItem(CONSENT_KEY, 'true');
      }
    }
  }

  // Check for existing consent
  if (localStorage.getItem(CONSENT_KEY) === 'true') {
    loadMap();
  }

  // Handle button click
  button?.addEventListener('click', loadMap);
</script>

<style>
  .map-section {
    padding: 2.5rem 0;
  }

  .map-wrapper {
    border-radius: var(--border-radius);
    overflow: hidden;
    border: 1px solid var(--color-border);
    height: 350px;
    background: var(--color-bg-alt);
    position: relative;
  }

  .map-wrapper iframe {
    width: 100%;
    height: 100%;
    border: 0;
  }

  /* Consent Placeholder */
  .map-consent {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, var(--color-bg-alt) 0%, var(--color-border) 100%);
  }

  .consent-content {
    text-align: center;
    padding: 2rem;
    max-width: 400px;
  }

  .consent-icon {
    width: 48px;
    height: 48px;
    color: var(--color-primary);
    margin-bottom: 1rem;
  }

  .consent-content h3 {
    font-family: var(--font-display);
    font-size: 1.2rem;
    color: var(--color-primary-dark);
    margin-bottom: 0.5rem;
  }

  .consent-content p {
    font-size: 0.9rem;
    color: var(--color-text-light);
    margin-bottom: 1rem;
    line-height: 1.5;
  }

  .consent-content a {
    color: var(--color-primary);
  }

  .consent-address {
    margin-top: 1rem;
    font-size: 0.85rem;
    color: var(--color-text);
  }

  .consent-address strong {
    color: var(--color-primary-dark);
  }
</style>
